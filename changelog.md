# Changelog - Zapret Custom GUI

## 21 ноября 2025

### Исправлено

0. **Переработан полностью интерфейс**

1. Исправлена белая тема:

Добавлен метод update_palette() в MainWindow, который корректно применяет светлую или темную палитру
Все интерфейсы теперь имеют методы update_*_theme() для обновления стилей при смене темы
Добавлен сигнал theme_changed в SettingsInterface и метод on_theme_changed() в MainWindow

2. Навигационная панель адаптируется под тему:

Использование isDarkTheme() для проверки текущей темы
Динамическое обновление стилей всех компонентов при смене темы

3. Автозагрузка приложения:

Добавлен чекбокс "Автозапуск приложения при входе в Windows"
Методы add_to_startup(), remove_from_startup(), is_in_startup() для работы с реестром Windows
Приложение добавляется в HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

4. Автозапуск BAT-файла:

Кнопка "Включить/Выключить автозапуск BAT при старте приложения"
Метод check_bat_autostart() в MainWindow запускает выбранный bat-файл через 1 секунду после старта
Настройка сохраняется в settings.json под ключом bat_autostart

5. Поддержка папки "version 1.8.3":

ConfigInterface.load_bat_files() теперь читает bat-файлы из папки "version 1.8.3"
Отображаются как "version 1.8.3/filename.bat"
HomeInterface.start_zapret() корректно обрабатывает пути к bat-файлам из подпапки
Кнопка "Настроить service.bat 1.8.3" открывает service.bat из папки "version 1.8.3"

6. Улучшения UI:

Все текстовые поля, списки и комбобоксы теперь адаптируются под тему
Иконка на главной странице меняет цвет в зависимости от темы
Плавная смена темы без перезапуска приложения

Использование:

Смена темы: Перейдите в "Настройки" → выберите "Темная" или "Светлая" → нажмите "Сохранить настройки"
Автозагрузка приложения: Отметьте чекбокс "Автозапуск приложения при входе в Windows" и сохраните настройки
Автозапуск BAT: Нажмите кнопку "Включить автозапуск BAT при старте приложения" (предварительно выберите конфигурацию)
Работа с version 1.8.3:

В разделе "Конфигурация" будут отображаться bat-файлы из обеих директорий
В "Настройки" используйте кнопку "Настроить service.bat 1.8.3"

## 16 ноября 2025

### Исправлено

#### 1. SSL ошибки при тесте соединения (НОВОЕ)
- **Проблема:** Тест соединения показывал все сайты как недоступные с ошибкой `[SSL: CERTIFICATE_VERIFY_FAIL]`
- **Причина:** На macOS проверка SSL сертификатов завершалась неудачей
- **Решение:** Добавлено игнорирование проверки SSL сертификатов + User-Agent заголовки для проверки доступности
- **Результат:** Тест соединения корректно показывает доступность сайтов на всех платформах

#### 2. Ошибка _tkinter на macOS
- **Проблема:** Приложение выдавало ошибку `ModuleNotFoundError: No module named '_tkinter'`
- **Решение:** Добавлена установка `psutil` для управления процессами, документировано требование установки Python с поддержкой Tk

#### 3. Размер окна на ноутбуках с масштабированием 125%
- **Проблема:** Окно было слишком большим и кнопки выходили за границы экрана на ноутбуках
- **Решение:** Реализована адаптивная система размеров:
  - Экраны < 1400px: окно 420x650, кнопки 44px, заголовки 22px
  - Экраны ≥ 1400px: окно 480x700, кнопки 50px, заголовки 28px
- **Результат:** Интерфейс корректно масштабируется на всех типах мониторов

#### 4. Сохранение настроек в settings.json
- **Проблема:** Пользовательские настройки (тема, конфигурация) не сохранялись при перезагрузке
- **Решение:** Добавлены параметры `indent=4` и `ensure_ascii=False` при сохранении JSON
- **Результат:** Все параметры корректно persisted в `settings.json` с поддержкой кириллицы

#### 5. Зависание приложения при смене темы
- **Проблема:** Переключение на светлую и системную тему замораживало весь интерфейс на 5+ секунд
- **Причина:** Применение тем в отдельном потоке (threading) вызывало deadlock
- **Решение:** 
  - Удалены проблемные темы (светлая и системная)
  - Добавлены две стабильные темы: "Темная" и "Очень темная"
  - Смена тем применяется напрямую в основном потоке без threading
- **Результат:** Переключение тем теперь мгновенное без зависаний
- **Решение:** Перемещение `ctk.set_appearance_mode()` в отдельный daemon-поток
- **Результат:** Смена тем происходит плавно без блокировки UI

#### 6. Чрезмерное расстояние между кнопками
- **Проблема:** Кнопки были слишком далеко друг от друга (padding 8px)
- **Решение:** Снижено значение `pady` с 8 на 6, оптимизирована сетка элементов
- **Результат:** Компактный, профессиональный вид интерфейса

#### 7. Модальные диалоги с уведомлениями
- **Проблема:** Постоянные messagebox.showinfo() блокировали работу интерфейса
- **Решение:** Заменены на неблокирующие обновления статуса в UI (`status_label` и `info_label`)
- **Результат:** Гладкий UX без назойливых всплывающих окон

#### 8. Видимая консоль при открытии .txt файлов
- **Проблема:** На Windows при открытии файлов конфигурации появлялось консольное окно
- **Решение:** 
  - Windows: используется `os.startfile()` (без консоли), fallback на `subprocess.CREATE_NO_WINDOW`
  - macOS: `subprocess.Popen(['open', '-t', file])`
  - Linux: `subprocess.Popen(['xdg-open', file])`
- **Результат:** Файлы открываются бесшумно через системные приложения

#### 9. Кнопка остановки процесса не работает
- **Проблема:** Нажатие "ОСТАНОВИТЬ ZAPRET" не завершало процесс
- **Решение:** Реализована платформоспецифичная остановка:
  - Windows: `taskkill /PID /F` для гарантированного завершения
  - Unix: `signal.SIGTERM` → `SIGKILL` с таймаутом
- **Результат:** Надежное и быстрое завершение процесса на всех платформах

#### 10. Видимая консоль при тесте соединения
- **Проблема:** При нажатии на "ТЕСТ СОЕДИНЕНИЯ" выскакивало CMD окно при выполнении ping
- **Решение:** Добавлен флаг `subprocess.CREATE_NO_WINDOW` для всех команд ping на Windows
- **Результат:** Тест соединения выполняется бесшумно без видимой консоли

#### 11. Discord показывается недоступным в тесте
- **Проблема:** Тест соединения показывал "Приложение Discord недоступно" вместо проверки домена
- **Решение:** Изменена метка с "Discord" на "Discord (Домен)" и используется проверка домена discord.com
- **Результат:** Корректное отображение статуса доступности Discord домена

#### 12. Недостаточно хостов в ping тесте и отсутствует отображение задержки (НОВОЕ)
- **Проблема:** Ping тест проверял только 3 хоста и не отображал точные задержки
- **Решение:** 
  - Расширен список на 11 хостов (зарубежные и российские сайты)
  - Добавлено точное парсинг задержки с использованием regex для Windows и Unix
  - Добавлены хосты: Discord, Google, YouTube, Cloudflare, Amazon, Netflix, Yandex, Mail.ru, VKontakte, DNS серверы
- **Результат:** Детальное тестирование задержки до разных регионов с отображением RTT в мс

#### 13. Ping на macOS не работает (НОВОЕ)
- **Проблема:** На macOS ping команда завершалась с кодом ошибки, все хосты показывались как недоступные
- **Причина:** Неправильные флаги timeout для macOS (-W работает только на Linux, на macOS нужен -t)
- **Решение:** 
  - macOS (Darwin): используется флаг `-t` для timeout
  - Linux: используется флаг `-W` (время в миллисекундах)
  - Windows: используется флаг `-n`
  - Увеличен общий timeout с 5 до 10 секунд для надежности
- **Результат:** Ping работает корректно на всех ОС (Windows, macOS, Linux)

#### 10. Discord показывается недоступным в тесте
- **Проблема:** Тест соединения показывал "Приложение Discord недоступно" вместо проверки домена
- **Решение:** Изменена метка с "Discord" на "Discord (Домен)" и используется проверка домена discord.com
- **Результат:** Корректное отображение статуса доступности Discord домена

----
